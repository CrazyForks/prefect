import createFetchClient, { type Middleware } from "openapi-fetch";
import createClient from "openapi-react-query";
import type { paths } from "./prefect.ts"; // generated by openapi-typescript

const BASE_URL = import.meta.env.VITE_API_URL;

const throwOnError: Middleware = {
	async onResponse({ response }) {
		if (!response.ok) {
			const body = (await response.clone().json()) as Record<string, unknown>;
			throw new Error(body.detail as string | undefined);
		}
	},
};

const client: ReturnType<typeof createFetchClient<paths>> =
	createFetchClient<paths>({
		baseUrl: BASE_URL,
	});

client.use(throwOnError);

export const getQueryService = () => {
	return client;
};

export const $api = createClient(client);
